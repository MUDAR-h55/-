<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نظام تسعيرة التوصيل</title>
<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --accent: #ff8a00;
    --muted: #94a3b8;
    --success: #16a34a;
    --danger: #dc2626;
    --glass: rgba(255, 255, 255, 0.03);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(180deg, var(--bg), #071024);
    color: #e6eef8;
    font-size: 15px;
  }
  .app {
    max-width: 460px;
    margin: 0 auto;
    padding: 15px;
  }
  h1, h3 {
    margin: 0 0 10px 0;
  }
  label {
    display: block;
    margin: 8px 0 4px 0;
    color: var(--muted);
    font-size: 13px;
  }
  input[type=text], input[type=number], select {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
    background: var(--glass);
    color: #eee;
    font-size: 15px;
  }
  button {
    background: var(--accent);
    border: none;
    padding: 10px 15px;
    border-radius: 10px;
    color: #041028;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    margin-top: 10px;
    transition: transform 0.1s ease;
  }
  button:active {
    transform: scale(0.95);
  }
  button.link-like {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(255,255,255,0.03);
    padding: 6px 10px;
    border-radius: 8px;
    margin-left: 5px;
  }
  button.link-like:hover {
    background: var(--accent);
    color: #041028;
  }
  .muted { color: var(--muted); font-size: 13px; }
  .small { font-size: 12px; }
  .hidden { display: none; }
  .entry {
    display: flex; justify-content: space-between;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    padding: 8px; border-radius: 8px; margin-bottom: 8px;
  }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { padding: 6px; border-bottom: 1px dashed rgba(255,255,255,0.1); font-size: 13px; text-align: right; }
  th { background: rgba(255,255,255,0.05); }
  .btn-danger { background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; }
  .btn-success { background: var(--success); color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; }
  input.edit-input { padding: 4px; font-size: 13px; border-radius: 6px; border: none; background: rgba(255,255,255,0.1); color: #eee; width: 100%; }
  input.edit-input:focus { outline: none; background: rgba(255,255,255,0.2); }
  #invoiceCanvas {
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background: var(--card); padding: 15px; border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.7); z-index: 10000; display: none;
  }
</style>
</head>
<body>
<div class="app" id="mainApp">
  <header>
    <h1>نظام تسعيرة التوصيل</h1>
    <button id="openStats">الإحصائيات</button>
  </header>

  <section id="mainForm">
    <label>اسم السائق</label>
    <input id="driverName" type="text" placeholder="اسم السائق" />

    <label>اسم الزبون</label>
    <input id="customerName" list="customersDatalist" type="text" placeholder="اختر أو اكتب اسم الزبون" />
    <datalist id="customersDatalist"></datalist>

    <label>الوجهة</label>
    <select id="destination"></select>

    <div id="otherPlaceRow" class="hidden">
      <label>اكتب اسم المكان (عند اختيار "أخرى")</label>
      <input id="otherPlace" type="text" placeholder="اسم المكان" />
    </div>

    <label>المبلغ (ليرة)</label>
    <input id="amount" type="number" min="0" step="0.01" />

    <label>تاريخ ووقت الطلعة</label>
    <input id="datetime" type="text" readonly />

    <div>
      <button id="saveBtn">سجل الطلعة</button>
      <button id="clearBtn" class="link-like">تفريغ البيانات</button>
      <button id="exportDataBtn" class="link-like">تصدير البيانات</button>
      <button id="importDataBtn" class="link-like">استيراد بيانات</button>
      <input type="file" id="importFileInput" accept=".json" style="display:none" />
    </div>

    <section id="recent" style="margin-top: 15px;"></section>
  </section>

  <hr style="margin:20px 0; border-color:#333;">
  <h3>إدارة الأماكن</h3>
  <label>اسم المكان</label>
  <input id="placeName" type="text" placeholder="أدخل اسم الوجهة" />
  <label>السعر (ليرة)</label>
  <input id="placePrice" type="number" min="0" step="0.01" />
  <button id="addPlaceBtn">➕ إضافة مكان</button>

  <table id="placesTable">
    <thead><tr><th>المكان</th><th>السعر</th><th>إجراءات</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="app hidden" id="statsPage" style="min-height:100vh; background: linear-gradient(180deg, #041226, #02141f); padding-bottom:40px;">
  <header>
    <h1>الإحصائيات</h1>
    <button id="backBtn" class="link-like">العودة</button>
  </header>
  <section>
    <div class="muted">إجمالي الطلعات: <strong id="totalTrips">0</strong></div>
    <div class="muted">إجمالي المبالغ: <strong id="totalAmount">0</strong> ليرة</div>
    <h3>قائمة الطلعات</h3>
    <table id="tripsTable"><thead>
      <tr><th>التاريخ</th><th>الزبون</th><th>الوجهة</th><th>المبلغ</th><th>السائق</th><th>الساعة</th><th>الإجراءات</th></tr>
    </thead><tbody></tbody></table>
  </section>
</div>

<div id="invoiceCanvas"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
(function(){
  const KEY_RECORDS='delivery_records_v2';
  const KEY_CUSTOMERS='delivery_customers_v2';
  const KEY_PLACES='delivery_places_v1';

  function getRecords(){ try{return JSON.parse(localStorage.getItem(KEY_RECORDS)||'[]');}catch(e){return[];} }
  function saveRecords(d){ localStorage.setItem(KEY_RECORDS,JSON.stringify(d)); }
  function getCustomers(){ try{return JSON.parse(localStorage.getItem(KEY_CUSTOMERS)||'[]');}catch(e){return[];} }
  function saveCustomers(d){ localStorage.setItem(KEY_CUSTOMERS,JSON.stringify(d)); }
  function getPlaces(){ try{return JSON.parse(localStorage.getItem(KEY_PLACES)||'[]');}catch(e){return[];} }
  function savePlaces(d){ localStorage.setItem(KEY_PLACES,JSON.stringify(d)); }

  const driverName=document.getElementById('driverName');
  const customerName=document.getElementById('customerName');
  const customersDatalist=document.getElementById('customersDatalist');
  const destination=document.getElementById('destination');
  const otherPlaceRow=document.getElementById('otherPlaceRow');
  const otherPlace=document.getElementById('otherPlace');
  const amount=document.getElementById('amount');
  const datetime=document.getElementById('datetime');
  const saveBtn=document.getElementById('saveBtn');
  const clearBtn=document.getElementById('clearBtn');
  const recentSection=document.getElementById('recent');
  const openStats=document.getElementById('openStats');
  const statsPage=document.getElementById('statsPage');
  const mainForm=document.getElementById('mainForm');
  const backBtn=document.getElementById('backBtn');
  const totalTripsEl=document.getElementById('totalTrips');
  const totalAmountEl=document.getElementById('totalAmount');
  const tripsTableBody=document.querySelector('#tripsTable tbody');
  const exportDataBtn=document.getElementById('exportDataBtn');
  const importDataBtn=document.getElementById('importDataBtn');
  const importFileInput=document.getElementById('importFileInput');
  const invoiceCanvas=document.getElementById('invoiceCanvas');

  const placeName=document.getElementById('placeName');
  const placePrice=document.getElementById('placePrice');
  const addPlaceBtn=document.getElementById('addPlaceBtn');
  const placesTableBody=document.querySelector('#placesTable tbody');

  function refreshCustomersDatalist(){
    const list=getCustomers();
    customersDatalist.innerHTML='';
    list.forEach(c=>{const opt=document.createElement('option'); opt.value=c; customersDatalist.appendChild(opt);});
  }

  function setNowDatetime(){ datetime.value=new Date().toLocaleString('ar-EG-u-nu-latn'); }

  function populateDestinations(){
    destination.innerHTML='';
    const places=getPlaces();
    places.forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d.label; opt.dataset.price=d.price;
      opt.textContent=`${d.label} — ${d.price} ليرة`;
      destination.appendChild(opt);
    });
    const other=document.createElement('option');
    other.value='أخرى'; other.textContent='أخرى';
    destination.appendChild(other);
  }

  function renderPlacesTable(){
    placesTableBody.innerHTML='';
    const places=getPlaces();
    places.forEach((p,i)=>{
      const tr=document.createElement('tr');
      const nameTd=document.createElement('td'); nameTd.textContent=p.label;
      const priceTd=document.createElement('td'); priceTd.textContent=p.price+' ليرة';
      const actTd=document.createElement('td');
      const editBtn=document.createElement('button'); editBtn.textContent='تعديل'; editBtn.className='btn-success';
      const delBtn=document.createElement('button'); delBtn.textContent='حذف'; delBtn.className='btn-danger';
      actTd.appendChild(editBtn); actTd.appendChild(delBtn);
      tr.appendChild(nameTd); tr.appendChild(priceTd); tr.appendChild(actTd);
      placesTableBody.appendChild(tr);
      editBtn.onclick=()=>{
        const newPrice=prompt('أدخل السعر الجديد',p.price);
        if(newPrice && !isNaN(parseFloat(newPrice))){
          places[i].price=parseFloat(newPrice);
          savePlaces(places); renderPlacesTable(); populateDestinations();
        }
      };
      delBtn.onclick=()=>{
        if(confirm('حذف المكان؟')){
          places.splice(i,1); savePlaces(places); renderPlacesTable(); populateDestinations();
        }
      };
    });
  }

  function onDestinationChange(){
    if(destination.value==='أخرى'){ otherPlaceRow.classList.remove('hidden'); amount.value=''; }
    else{
      otherPlaceRow.classList.add('hidden'); otherPlace.value='';
      const sel=[...destination.options].find(o=>o.value===destination.value);
      amount.value=sel?sel.dataset.price:'';
    }
  }

  function renderRecent(){
    const recs=getRecords();
    if(recs.length===0){ recentSection.innerHTML='<div class="muted small">لا توجد طلعات.</div>'; return; }
    let html='<h3>آخر الطلعات</h3>';
    recs.slice(0,8).forEach(r=>{
      const dt=new Date(r.datetime).toLocaleString('ar-EG-u-nu-latn');
      html+=`<div class="entry"><div><strong>${r.customer}</strong><br><small>${dt}</small></div>
      <div style="text-align:left;"><div><strong>${r.amount.toFixed(2)} ليرة</strong></div><div class="muted small">${r.destination}</div></div></div>`;
    });
    recentSection.innerHTML=html;
  }

  function buildStats(){
    const recs=getRecords();
    totalTripsEl.textContent=recs.length;
    totalAmountEl.textContent=recs.reduce((s,r)=>s+r.amount,0).toFixed(2);
    tripsTableBody.innerHTML='';
    recs.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${new Date(r.datetime).toLocaleString('ar-EG-u-nu-latn')}</td>
      <td>${r.customer}</td><td>${r.destination}</td>
      <td>${r.amount.toFixed(2)} ليرة</td><td>${r.driver}</td>
      <td>${new Date(r.datetime).toLocaleTimeString('en-US',{hour12:false})}</td>
      <td><button class="btn-danger">حذف</button></td>`;
      tr.querySelector('button').onclick=()=>{
        const recs2=getRecords(); const idx=recs2.findIndex(x=>x.id===r.id);
        if(idx>=0){ recs2.splice(idx,1); saveRecords(recs2); buildStats(); renderRecent(); }
      };
      tripsTableBody.appendChild(tr);
    });
  }

  function onSave(){
    const driver=driverName.value.trim(), customer=customerName.value.trim();
    let dest=destination.value, other=otherPlace.value.trim();
    const amt=parseFloat(amount.value), dtIso=new Date().toISOString();
    if(!driver||!customer||isNaN(amt)||amt<=0) return alert('أدخل بيانات صحيحة');
    if(dest==='أخرى'){ if(!other) return alert('أدخل اسم المكان'); dest=other; }
    const record={id:Date.now(),driver,customer,destination:dest,amount:amt,datetime:dtIso};
    const recs=getRecords(); recs.unshift(record); saveRecords(recs);
    const custs=getCustomers(); if(!custs.includes(customer)){ custs.unshift(customer); saveCustomers(custs.slice(0,200)); }
    refreshCustomersDatalist(); renderRecent(); buildStats(); datetime.value=new Date().toLocaleString('ar-EG-u-nu-latn');
  }

  function onClear(){ if(confirm('حذف جميع البيانات؟')){ localStorage.clear(); renderRecent(); buildStats(); refreshCustomersDatalist(); populateDestinations(); renderPlacesTable(); } }

  function init(){
    if(getPlaces().length===0){ savePlaces([{label:'طلعة بحيرة عنتاب',price:50},{label:'طلعة المعبر',price:35}]); }
    populateDestinations(); renderPlacesTable(); refreshCustomersDatalist(); renderRecent(); buildStats(); setNowDatetime();
    const lastDriver=localStorage.getItem('last_driver_name')||''; driverName.value=lastDriver;
    destination.onchange=onDestinationChange; saveBtn.onclick=onSave; clearBtn.onclick=onClear;
    openStats.onclick=()=>{statsPage.classList.remove('hidden'); mainForm.classList.add('hidden');};
    backBtn.onclick=()=>{statsPage.classList.add('hidden'); mainForm.classList.remove('hidden');};
    exportDataBtn.onclick=()=>{ const data={records:getRecords(),customers:getCustomers(),places:getPlaces()}; const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='delivery.json'; a.click(); };
    importDataBtn.onclick=()=>importFileInput.click();
    importFileInput.onchange=(e)=>{const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{try{const d=JSON.parse(ev.target.result); if(d.records)saveRecords(d.records); if(d.customers)saveCustomers(d.customers); if(d.places)savePlaces(d.places); populateDestinations(); renderPlacesTable(); renderRecent(); buildStats(); refreshCustomersDatalist(); alert('تم الاستيراد');}catch(e){alert('خطأ بالملف');}}; r.readAsText(f);};
    addPlaceBtn.onclick=()=>{const n=placeName.value.trim(), p=parseFloat(placePrice.value); if(!n||isNaN(p)||p<=0) return alert('أدخل بيانات صحيحة'); const places=getPlaces(); places.push({label:n,price:p}); savePlaces(places); placeName.value=''; placePrice.value=''; populateDestinations(); renderPlacesTable();};
  }
  init();
})();
</script>
</body>
</html>
