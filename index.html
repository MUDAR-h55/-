<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</title>
<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --accent: #ff8a00;
    --muted: #94a3b8;
    --success: #16a34a;
    --danger: #dc2626;
    --glass: rgba(255, 255, 255, 0.03);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: linear-gradient(180deg, var(--bg), #071024);
    color: #e6eef8;
    font-size: 15px;
  }
  .app {
    max-width: 460px;
    margin: 0 auto;
    padding: 15px;
  }
  h1, h3 {
    margin: 0 0 10px 0;
  }
  label {
    display: block;
    margin: 8px 0 4px 0;
    color: var(--muted);
    font-size: 13px;
  }
  input[type=text], input[type=number], select {
    width: 100%;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
    background: var(--glass);
    color: #eee;
    font-size: 15px;
  }
  select {
    cursor: pointer;
  }
  button {
    background: var(--accent);
    border: none;
    padding: 10px 15px;
    border-radius: 10px;
    color: #041028;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    margin-top: 15px;
    transition: transform 0.1s ease;
  }
  button:active {
    transform: scale(0.95);
  }
  button.link-like {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(255,255,255,0.03);
    padding: 8px 12px;
    border-radius: 8px;
    margin-left: 8px;
  }
  button.link-like:hover {
    background: var(--accent);
    color: #041028;
  }
  .muted {
    color: var(--muted);
    font-size: 13px;
  }
  .small {
    font-size: 12px;
  }
  .hidden {
    display: none;
  }
  .entry {
    display: flex;
    justify-content: space-between;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 8px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px dashed rgba(255,255,255,0.1);
    font-size: 13px;
    text-align: right;
    vertical-align: middle;
  }
  th {
    background: rgba(255,255,255,0.05);
  }
  .btn-danger {
    background: var(--danger);
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }
  .btn-success {
    background: var(--success);
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }
  input.edit-input {
    padding: 6px;
    font-size: 13px;
    border-radius: 6px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: #eee;
    width: 100%;
  }
  input.edit-input:focus {
    outline: none;
    background: rgba(255,255,255,0.2);
  }
  #invoiceCanvas {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--card);
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.7);
    z-index: 10000;
    display: none;
  }
  @media (max-width: 480px) {
    .app {
      padding: 12px;
    }
  }
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff8a00">

</head>
<body>
<div class="app" id="mainApp">
  <header>
    <h1>Ù†Ø¸Ø§Ù… ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</h1>
    <button id="openStats">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
  </header>

  <section id="mainForm">
    <label>Ø§Ø³Ù… Ø³Ø§Ø¦Ù‚ Ø§Ù„ÙØªÙ‰ (ÙŠÙ…Ù„Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)</label>
    <input id="driverName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚" />

    <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</label>
    <input id="customerName" list="customersDatalist" type="text" placeholder="Ø§Ø®ØªØ± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" />
    <datalist id="customersDatalist"></datalist>

    <label>Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
    <select id="destination"></select>

    <div id="otherPlaceRow" class="hidden">
      <label>Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† (Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ø®Ø±Ù‰")</label>
      <input id="otherPlace" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†" />
    </div>

    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ù„ÙŠØ±Ø©)</label>
    <input id="amount" type="number" min="0" step="0.01" />

    <label>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¹Ø©</label>
    <input id="datetime" type="text" readonly />

    <div style="margin-top: 12px;">
      <button id="saveBtn">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¹Ø©</button>
      <button id="clearBtn" class="link-like">ØªÙØ±ÙŠØº Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button id="exportDataBtn" class="link-like">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button id="importDataBtn" class="link-like">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <input type="file" id="importFileInput" accept=".json" style="display:none" />
    </div>

    <div class="muted small" style="margin-top: 8px;">
      ÙƒÙ„ 5 Ø·Ù„Ø¹Ø§Øª Ù„ÙƒÙ„ Ø²Ø¨ÙˆÙ† ØªÙØ¶Ø§Ù Ø¶Ø±ÙŠØ¨Ø© 50 Ù„ÙŠØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.
    </div>

    <section id="recent" style="margin-top: 15px;"></section>
  </section>
</div>

<div class="app hidden" id="statsPage" style="min-height: 100vh; background: linear-gradient(180deg, #041226, #02141f); padding-bottom: 40px;">
  <header>
    <h1>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h1>
    <button id="backBtn" class="link-like">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
  </header>

  <section>
    <div style="display:flex; justify-content: space-between; flex-wrap: wrap;">
      <div style="flex:1; min-width:160px;">
        <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¹Ø§Øª: <strong id="totalTrips">0</strong></div>
        <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <strong id="totalAmount">0</strong> Ù„ÙŠØ±Ø©</div>
        <div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ Ø§Ù„Ù…Ø­ØµÙ„Ø©: <strong id="totalTax">0</strong> Ù„ÙŠØ±Ø©</div>
      </div>
      <div style="flex:1; min-width:160px; text-align:center; margin-top:8px;">
        <button id="printStats">Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    </div>

    <h3>Ø§Ù„ØªÙØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†</h3>
    <div id="customersStats"></div>

    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¹Ø§Øª</h3>
    <table id="tripsTable" style="width: 100%;">
      <thead>
        <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><th>Ø§Ù„ÙˆØ¬Ù‡Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ø³Ø§Ø¹Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- Ø¹Ù†ØµØ± Ù„Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="invoiceCanvas"></div>

<!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© html2canvas Ù„ØªØ­ÙˆÙŠÙ„ DIV Ø¥Ù„Ù‰ ØµÙˆØ±Ø© PNG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
(function(){
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playClickSound(){
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(440, audioCtx.currentTime);
    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.connect(gainNode).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
  }

  const DESTINATIONS = [
    {label:'Ø·Ù„Ø¹Ø© Ø¨Ø­ÙŠØ±Ø© Ø¹Ù†ØªØ§Ø¨', price:50},
    {label:'Ø·Ù„Ø¹Ø© Ø§Ù„Ù…Ø¹Ø¨Ø± ğŸ›ï¸', price:35},
    {label:'Ø·Ù„Ø¹Ø© Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ø­Ø§Ø¬Ø²', price:35},
    {label:'Ø·Ù„Ø¹Ø© Ø¬Ø¨Ù„ â›°ï¸', price:30},
    {label:'Ø·Ù„Ø¹Ø© Ù…Ø´ÙÙ‰ ğŸš¨', price:30},
    {label:'Ø·Ù„Ø¹Ø© Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ù†Øª Ø£Ùˆ Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„ÙØ³ØªÙ‚', price:30},
    {label:'Ø·Ù„Ø¹Ø© Ø¯ÙˆØ§Ø± Ø§Ù„112', price:25},
    {label:'Ø·Ù„Ø¹Ø© Ø£ÙƒØ±Ù… Ø¬Ø§ØªÙŠÙ†', price:25},
    {label:'Ø·Ù„Ø¹Ø© Ù…Ø³Ø¨Ø­ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©', price:25},
    {label:'Ø·Ù„Ø¹Ø© Ù…Ø³Ø¨Ø­ ØºØ±Ø§ØªÙˆØ³', price:20},
    {label:'ÙØªØ­Ø© Ø§Ù„Ø¨Ø§Ø¨', price:20},
    {label:'Ø£Ø®Ø±Ù‰', price:0}
  ];
  const TAX_PER_5 = 50;
  const KEY_RECORDS = 'delivery_records_v2';
  const KEY_CUSTOMERS = 'delivery_customers_v2';

  // DOM elements
  const driverName = document.getElementById('driverName');
  const customerName = document.getElementById('customerName');
  const customersDatalist = document.getElementById('customersDatalist');
  const destination = document.getElementById('destination');
  const otherPlaceRow = document.getElementById('otherPlaceRow');
  const otherPlace = document.getElementById('otherPlace');
  const amount = document.getElementById('amount');
  const datetime = document.getElementById('datetime');
  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const recentSection = document.getElementById('recent');

  const openStats = document.getElementById('openStats');
  const statsPage = document.getElementById('statsPage');
  const mainForm = document.getElementById('mainForm');
  const backBtn = document.getElementById('backBtn');
  const printStats = document.getElementById('printStats');

  const totalTripsEl = document.getElementById('totalTrips');
  const totalAmountEl = document.getElementById('totalAmount');
  const totalTaxEl = document.getElementById('totalTax');
  const customersStats = document.getElementById('customersStats');
  const tripsTableBody = document.querySelector('#tripsTable tbody');

  const exportDataBtn = document.getElementById('exportDataBtn');
  const importDataBtn = document.getElementById('importDataBtn');
  const importFileInput = document.getElementById('importFileInput');

  const invoiceCanvas = document.getElementById('invoiceCanvas');

  // Helpers
  function getRecords(){
    try { return JSON.parse(localStorage.getItem(KEY_RECORDS) || '[]'); }
    catch(e) { return []; }
  }
  function saveRecords(data){ localStorage.setItem(KEY_RECORDS, JSON.stringify(data)); }

  function getCustomers(){
    try { return JSON.parse(localStorage.getItem(KEY_CUSTOMERS) || '[]'); }
    catch(e) { return []; }
  }
  function saveCustomers(data){ localStorage.setItem(KEY_CUSTOMERS, JSON.stringify(data)); }

  function refreshCustomersDatalist(){
    const list = getCustomers();
    customersDatalist.innerHTML = '';
    list.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c;
      customersDatalist.appendChild(opt);
    });
  }

  function setNowDatetime(){
    // Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø³Ø§Ø¹Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ ISO Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ­Ø±ÙŠØ± Ù„Ø§Ø­Ù‚Ø§Ù‹
    datetime.value = new Date().toLocaleString('ar-EG-u-nu-latn');
  }

  function populateDestinations(){
    destination.innerHTML = '';
    DESTINATIONS.forEach(d=>{
      const opt = document.createElement('option');
      opt.value = d.label;
      opt.dataset.price = d.price;
      opt.textContent = `${d.label} â€” ${d.price} Ù„ÙŠØ±Ø©`;
      destination.appendChild(opt);
    });
  }

  function onDestinationChange(){
    if(destination.value === 'Ø£Ø®Ø±Ù‰'){
      otherPlaceRow.classList.remove('hidden');
      amount.value = '';
      amount.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¯ÙˆÙŠØ§Ù‹';
    } else {
      otherPlaceRow.classList.add('hidden');
      otherPlace.value = '';
      const sel = [...destination.options].find(o => o.value === destination.value);
      amount.value = sel ? sel.dataset.price : '';
    }
  }

  function renderRecent(){
    const recs = getRecords();
    if(recs.length === 0){
      recentSection.innerHTML = '<div class="muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</div>';
      return;
    }
    let html = '<h3>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¹Ø§Øª</h3>';
    const slice = recs.slice(0, 8);
    slice.forEach(r=>{
      const dt = new Date(r.datetime).toLocaleString('ar-EG-u-nu-latn');
      html += `
        <div class="entry">
          <div><strong>${r.customer}</strong><br><small class="muted">${dt}</small></div>
          <div style="text-align:left;">
            <div><strong>${r.amount.toFixed(2)} Ù„ÙŠØ±Ø©</strong></div>
            <div class="muted small">${r.destination}</div>
          </div>
        </div>`;
    });
    recentSection.innerHTML = html;
  }

  function createInvoiceDiv(rec){
    // Ø¥Ù†Ø´Ø§Ø¡ DIV ÙŠØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    invoiceCanvas.innerHTML = '';
    const div = document.createElement('div');
    div.style.padding = '12px';
    div.style.color = '#eee';
    div.style.fontSize = '14px';
    div.style.width = '300px';
    div.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    div.style.background = '#222831';
    div.style.borderRadius = '12px';
    div.style.textAlign = 'right';
    div.innerHTML = `
      <h2 style="margin:0 0 10px 0; text-align:center; color:#ff8a00;">ÙØ§ØªÙˆØ±Ø© ØªÙˆØµÙŠÙ„</h2>
      <div><strong>Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${rec.driver}</div>
      <div><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> ${rec.customer}</div>
      <div><strong>Ø§Ù„ÙˆØ¬Ù‡Ø©:</strong> ${rec.destination}</div>
      <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${rec.amount.toFixed(2)} Ù„ÙŠØ±Ø©</div>
      <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(rec.datetime).toLocaleString('ar-EG-u-nu-latn')}</div>
      <div style="margin-top: 10px; text-align:center; font-size: 12px; color:#aaa;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ÙƒÙ… Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„</div>
    `;
    invoiceCanvas.appendChild(div);
    invoiceCanvas.style.display = 'block';
  }

  function saveInvoicePNG(){
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… html2canvas Ù„ØªØ­ÙˆÙŠÙ„ div Ø¥Ù„Ù‰ ØµÙˆØ±Ø© ÙˆØ­ÙØ¸Ù‡Ø§
    return html2canvas(invoiceCanvas, {backgroundColor: null}).then(canvas=>{
      const link = document.createElement('a');
      link.download = `ÙØ§ØªÙˆØ±Ø©_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      invoiceCanvas.style.display = 'none';
    });
  }

  function onSave(){
    playClickSound();
    const driver = driverName.value.trim();
    let customer = customerName.value.trim();
    let dest = destination.value;
    const other = otherPlace.value.trim();
    const amt = parseFloat(amount.value);
    const dtIso = new Date().toISOString();

    if(!driver){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚'); return; }
    if(!customer){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†'); return; }
    if(dest === 'Ø£Ø®Ø±Ù‰'){
      if(!other){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø£Ø®Ø±Ù‰"'); return; }
      dest = other;
    }
    if(isNaN(amt) || amt <= 0){ alert('Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­'); return; }

    const record = {id:Date.now(), driver, customer, destination: dest, amount: amt, datetime: dtIso};
    const recs = getRecords();
    recs.unshift(record);
    saveRecords(recs);

    // Ø­ÙØ¸ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙÙŠ Ù‚Ø§Ø¦Ù…Ø©
    const customers = getCustomers();
    if(!customers.includes(customer)){
      customers.unshift(customer);
      saveCustomers(customers.slice(0, 200));
    }
    refreshCustomersDatalist();
    renderRecent();
    buildStats();

    // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.setItem('last_driver_name', driver);

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¹Ø±Ø¶
    datetime.value = new Date().toLocaleString('ar-EG-u-nu-latn');

    // Ø¹Ø±Ø¶ ÙˆØ­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© png
    createInvoiceDiv(record);
    saveInvoicePNG();

    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø²Ø¨ÙˆÙ†
    amount.value = '';
    if(dest === other) otherPlace.value = '';
    if(destination.value === 'Ø£Ø®Ø±Ù‰') destination.value = '';

    // Ù…Ø¤Ø«Ø± ØµÙˆØªÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
    playClickSound();
  }

  function onClear(){
    playClickSound();
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')){
      localStorage.removeItem(KEY_RECORDS);
      localStorage.removeItem(KEY_CUSTOMERS);
      renderRecent();
      buildStats();
      refreshCustomersDatalist();
    }
  }

  function buildStats(){
    const recs = getRecords();
    let totalTrips = recs.length;
    let totalAmount = 0;
    const byCust = {};
    recs.forEach(r=>{
      totalAmount += r.amount;
      if(!byCust[r.customer]) byCust[r.customer] = {trips:0, amount:0};
      byCust[r.customer].trips++;
      byCust[r.customer].amount += r.amount;
    });

    let totalTax = 0;
    let custHtml = '';
    for(const cust in byCust){
      const data = byCust[cust];
      const taxCount = Math.floor(data.trips / 5);
      const tax = taxCount * TAX_PER_5;
      totalTax += tax;
      custHtml += `<div class="entry">
        <div><strong>${cust}</strong><br><small class="muted">${data.trips} Ø·Ù„Ø¹Ø§Øª â€” ${data.amount.toFixed(2)} Ù„ÙŠØ±Ø©</small></div>
        <div style="text-align:left"><small class="muted">Ø¶Ø±ÙŠØ¨Ø©: <strong>${tax}</strong> Ù„ÙŠØ±Ø©</small></div>
      </div>`;
    }
    if(!custHtml) custHtml = '<div class="muted small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</div>';

    totalTripsEl.textContent = totalTrips;
    totalAmountEl.textContent = totalAmount.toFixed(2);
    totalTaxEl.textContent = totalTax.toFixed(2);
    customersStats.innerHTML = custHtml;

    // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¹Ø§Øª Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù
    tripsTableBody.innerHTML = '';
    recs.forEach(r=>{
      const tr = document.createElement('tr');

      const dtCell = document.createElement('td');
      dtCell.textContent = new Date(r.datetime).toLocaleString('ar-EG-u-nu-latn');
      dtCell.dataset.id = r.id;
      dtCell.className = 'editable-cell';
      dtCell.dataset.field = 'datetime';

      const custCell = document.createElement('td');
      custCell.textContent = r.customer;
      custCell.className = 'editable-cell';
      custCell.dataset.id = r.id;
      custCell.dataset.field = 'customer';

      const destCell = document.createElement('td');
      destCell.textContent = r.destination;
      destCell.className = 'editable-cell';
      destCell.dataset.id = r.id;
      destCell.dataset.field = 'destination';

      const amtCell = document.createElement('td');
      amtCell.textContent = r.amount.toFixed(2) + ' Ù„ÙŠØ±Ø©';
      amtCell.className = 'editable-cell';
      amtCell.dataset.id = r.id;
      amtCell.dataset.field = 'amount';

      const driverCell = document.createElement('td');
      driverCell.textContent = r.driver;
      driverCell.style.textAlign = 'center';

      const timeCell = document.createElement('td');
      // Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„ÙˆÙ‚Øª (Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©:Ø«Ø§Ù†ÙŠØ©) Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø¬Ù†Ø¨ÙŠØ©
      timeCell.textContent = new Date(r.datetime).toLocaleTimeString('en-US', {hour12:false});
      timeCell.style.textAlign = 'center';

      const actionsCell = document.createElement('td');
      actionsCell.style.textAlign = 'center';

      const editBtn = document.createElement('button');
      editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
      editBtn.className = 'link-like';
      editBtn.style.minWidth = '60px';

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Ø­Ø°Ù';
      delBtn.className = 'link-like btn-danger';
      delBtn.style.minWidth = '60px';

      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(delBtn);

      tr.appendChild(dtCell);
      tr.appendChild(custCell);
      tr.appendChild(destCell);
      tr.appendChild(amtCell);
      tr.appendChild(driverCell);
      tr.appendChild(timeCell);
      tr.appendChild(actionsCell);

      tripsTableBody.appendChild(tr);

      let editing = false;
      editBtn.addEventListener('click', ()=>{
        if(!editing){
          [dtCell,custCell,destCell,amtCell].forEach(cell=>{
            const val = cell.textContent.replace(' Ù„ÙŠØ±Ø©','').trim();
            const input = document.createElement('input');
            input.type = (cell.dataset.field==='amount') ? 'number' : 'text';
            if(cell.dataset.field === 'amount') input.step = "0.01";
            input.className = 'edit-input';
            input.value = val;
            cell.textContent = '';
            cell.appendChild(input);
          });
          editBtn.textContent = 'Ø­ÙØ¸';
          editing = true;
        } else {
          const inputs = [dtCell,custCell,destCell,amtCell].map(c=>c.querySelector('input'));
          if(!inputs[1].value.trim()){ alert('Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ø·Ù„ÙˆØ¨'); return; }
          if(!inputs[2].value.trim()){ alert('Ø§Ù„ÙˆØ¬Ù‡Ø© Ù…Ø·Ù„ÙˆØ¨Ø©'); return; }
          const amtVal = parseFloat(inputs[3].value);
          if(isNaN(amtVal) || amtVal<=0){ alert('Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­'); return; }

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
          const records = getRecords();
          const idx = records.findIndex(x=>x.id == dtCell.dataset.id);
          if(idx < 0){ alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
          let newDateIso;
          try {
            const dtInput = new Date(inputs[0].value);
            if(isNaN(dtInput)) throw 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
            newDateIso = dtInput.toISOString();
          } catch(e) {
            alert('ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­');
            return;
          }

          records[idx].datetime = newDateIso;
          records[idx].customer = inputs[1].value.trim();
          records[idx].destination = inputs[2].value.trim();
          records[idx].amount = amtVal;
          saveRecords(records);

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
          const customers = getCustomers();
          if(!customers.includes(records[idx].customer)){
            customers.unshift(records[idx].customer);
            saveCustomers(customers.slice(0,200));
          }
          refreshCustomersDatalist();

          buildStats();

          editing = false;
          editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
        }
      });

      delBtn.addEventListener('click', ()=>{
        playClickSound();
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')){
          const records = getRecords();
          const idx = records.findIndex(x=>x.id == dtCell.dataset.id);
          if(idx >= 0){
            records.splice(idx, 1);
            saveRecords(records);
            buildStats();
            renderRecent();
          }
        }
      });
    });
  }

  // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª JSON
  function onExportData(){
    playClickSound();
    const records = getRecords();
    const customers = getCustomers();
    const data = {records, customers};
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'delivery_data.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª JSON
  function onImportData(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(event){
      try{
        const data = JSON.parse(event.target.result);
        if(!data.records || !data.customers) throw 'ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­';

        const currentRecords = getRecords();
        const currentIds = new Set(currentRecords.map(r=>r.id));
        data.records.forEach(r=>{
          if(!currentIds.has(r.id)) currentRecords.push(r);
        });
        saveRecords(currentRecords);

        const currentCustomers = getCustomers();
        data.customers.forEach(c=>{
          if(!currentCustomers.includes(c)) currentCustomers.push(c);
        });
        saveCustomers(currentCustomers);

        refreshCustomersDatalist();
        renderRecent();
        alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§');
      }catch(err){
        alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err);
      }
      importFileInput.value = '';
    };
    reader.readAsText(file);
  }

  // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  function openStatsView(){
    playClickSound();
    statsPage.classList.remove('hidden');
    mainForm.classList.add('hidden');
  }

  // Ø¥ØºÙ„Ø§Ù‚ ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  function closeStatsView(){
    playClickSound();
    statsPage.classList.add('hidden');
    mainForm.classList.remove('hidden');
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  function init(){
    populateDestinations();
    refreshCustomersDatalist();
    renderRecent();
    setNowDatetime();

    const lastDriver = localStorage.getItem('last_driver_name') || '';
    driverName.value = lastDriver;

    destination.addEventListener('change', ()=>{
      playClickSound();
      onDestinationChange();
    });
    saveBtn.addEventListener('click', onSave);
    clearBtn.addEventListener('click', onClear);
    openStats.addEventListener('click', openStatsView);
    backBtn.addEventListener('click', closeStatsView);
    printStats.addEventListener('click', ()=>{
      playClickSound();
      window.print();
    });
    exportDataBtn.addEventListener('click', onExportData);
    importDataBtn.addEventListener('click', ()=>{
      playClickSound();
      importFileInput.click();
    });
    importFileInput.addEventListener('change', onImportData);
  }

  init();
})();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­"))
    .catch((err) => console.log("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker", err));
}
</script>

</body>
</html>
